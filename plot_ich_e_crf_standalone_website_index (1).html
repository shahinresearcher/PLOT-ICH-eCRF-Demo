<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PLOT‑ICH eCRF – Partial Capture</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <link rel="icon" href="data:," />
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    (function(){
      const React = window.React;
      const ReactDOM = window.ReactDOM;
      const XLSX = window.XLSX;

      const { useEffect, useState } = React;

      const STORE_KEY = 'plotich_store_v2';
      const SET_KEY = 'plotich_settings_v1';

      function useLocalStorage(key, initial) {
        const [val, setVal] = useState(function(){
          try { var t = localStorage.getItem(key); return t ? JSON.parse(t) : initial; } catch (e) { return initial; }
        });
        useEffect(function(){ try { localStorage.setItem(key, JSON.stringify(val)); } catch (e) {} }, [key, val]);
        return [val, setVal];
      }

      function csvEscape(v) {
        var s = (v == null ? '' : String(v));
        var needsWrap = s.indexOf('"') > -1 || s.indexOf(',') > -1 || s.indexOf('\n') > -1;
        var escaped = s.split('"').join('""');
        return needsWrap ? '"' + escaped + '"' : escaped;
      }

      function buildFlatColumns(schema) {
        var cols = { orion_id: true };
        Object.keys(schema).forEach(function(secKey){
          var sec = schema[secKey];
          sec.fields.forEach(function(f){ if (f.name !== 'orion_id') { cols[secKey + '__' + f.name] = true; } });
        });
        return Object.keys(cols);
      }

      function buildFlattenRows(schema, store) {
        return Object.keys(store).map(function(orion){
          var data = store[orion] || {};
          var row = { orion_id: orion };
          Object.keys(schema).forEach(function(secKey){
            var secData = (data[secKey] && typeof data[secKey] === 'object') ? data[secKey] : {};
            Object.keys(secData).forEach(function(name){
              if (name === 'orion_id') return;
              var val = secData[name];
              row[secKey + '__' + name] = Array.isArray(val) ? val.join('; ') : val;
            });
          });
          return row;
        });
      }

      var schema = {
        section1: {
          title: 'SECTION 1: Initial Presentation & Admission',
          fields: [
            { name: 'orion_id', label: 'ORION Unique Patient Identifier', type: 'text', required: true },
            { name: 'sex', label: 'Sex', type: 'radio', options: ['Male','Female'] },
            { name: 'age', label: 'Age (years at admission)', type: 'number' },
            { name: 'onset_dt', label: 'Date/time of symptom onset', type: 'datetime' },
            { name: 'presenting_symptoms', label: 'Presenting symptoms', type: 'checkbox', options: ['Collapse','Headache','Focal neurological deficit','Speech disturbance','Seizure'] },
            { name: 'admission_dt', label: 'Date/time of admission to hospital', type: 'datetime' },
            { name: 'direct_transfer', label: 'Direct transfer to your hospital?', type: 'radio', options: ['Yes','No'] },
            { name: 'transfer_from', label: 'Hospital patient was transferred from', type: 'text' },
            { name: 'transport', label: 'Method of transport', type: 'radio', options: ['Helicopter','Land ambulance (paramedics)','Land ambulance (non-paramedics)','Police','Private vehicle','Foot','Other'] },
            { name: 'asa', label: 'ASA classification', type: 'radio', options: ['I','II','III','IV','V'] },
            { name: 'gcs_adm', label: 'GCS on admission (total)', type: 'number' },
            { name: 'pupils', label: 'Pupillary response (per eye)', type: 'select', options: ['Reactive','Fixed/dilated','Small/unreactive','Unknown'] },
            { name: 'nihss', label: 'NIHSS on admission', type: 'number' },
            { name: 'wfns', label: 'WFNS scale (if SAH)', type: 'radio', options: ['1','2','3','4','5'] },
            { name: 'comorbid', label: 'Known comorbidities', type: 'checkbox', options: ['None','Hypertension','Atrial fibrillation','Diabetes','Family history of aneurysm','Obesity','HIV','Previous stroke','Bleeding disorder','Sickle cell'] },
            { name: 'meds', label: 'Known medication history', type: 'checkbox', options: ['Antiplatelet','Anticoagulant','None','Unknown'] },
            { name: 'ac_type', label: 'Anticoagulant type (if yes)', type: 'radio', options: ['Warfarin','DOAC','Heparin'] },
            { name: 'bmi', label: 'Body mass index', type: 'number' },
            { name: 'smoking', label: 'Smoking status', type: 'radio', options: ['Yes','No','Ex-smoker','Unknown'] },
            { name: 'illicit', label: 'Illicit drug use', type: 'radio', options: ['Yes','No','Unknown'] },
            { name: 'alcohol', label: 'Alcohol use', type: 'radio', options: ['Yes','No','Unknown'] },
            { name: 'admission_location', label: 'Admission location', type: 'radio', options: ['General ward','Stroke unit','Neurology ward','Neurosurgery ward','HDU','ICU'] },
            { name: 'admitting_team', label: 'Admitting team', type: 'radio', options: ['Emergency medicine','General medicine','Stroke','Neurology','Neurosurgery','Intensive care'] },
          ]
        },
        section2: {
          title: 'SECTION 2: Imaging Data',
          fields: [
            { name: 'orion_id', label: 'ORION Unique Patient Identifier', type: 'text', required: true },
            { name: 'first_imaging_dt', label: 'Date/time of first imaging', type: 'datetime' },
            { name: 'first_imaging_here', label: 'First imaging at your institution', type: 'radio', options: ['Yes','No'] },
            { name: 'first_imaging_modality', label: 'First imaging modality', type: 'radio', options: ['CT','MRI','X-ray','Ultrasound'] },
            { name: 'primary_ich_type', label: 'Primary ICH type', type: 'radio', options: ['Subarachnoid','Intraparenchymal','Intraventricular'] },
            { name: 'lateralisation', label: 'Lateralisation (if intraparenchymal)', type: 'radio', options: ['Right','Left','Multifocal','Midline'] },
            { name: 'midline_shift', label: 'Midline shift', type: 'radio', options: ['None','1–5mm','6–10mm','>10mm'] },
            { name: 'iv_extension', label: 'Intraventricular extension', type: 'radio', options: ['Yes','No'] },
            { name: 'sah_extension', label: 'Subarachnoid extension', type: 'radio', options: ['Yes','No'] },
            { name: 'basal_cisterns', label: 'Basal cisterns', type: 'radio', options: ['Open','Compressed/obliterated'] },
            { name: 'location', label: 'Location', type: 'radio', options: ['Cortical/lobar','Basal ganglia/internal capsule/thalamus','Pons/brainstem','Cerebellum'] },
            { name: 'hydrocephalus', label: 'Hydrocephalus', type: 'radio', options: ['Yes','No'] },
            { name: 'ich_volume', label: 'Volume of ICH', type: 'select', options: ['Unknown','0–15mL','15–30mL','30–60mL','>60mL'] },
            { name: 'ich_score', label: 'ICH score', type: 'number' },
            { name: 'sich_score', label: 'sICH score', type: 'number' },
            { name: 'advanced_imaging', label: 'Advanced imaging performed?', type: 'radio', options: ['Yes','No'] },
            { name: 'vascular_imaging', label: 'Type of vascular imaging', type: 'radio', options: ['DSA','CTA','MRA'] },
            { name: 'underlying_cause', label: 'Underlying cause identified', type: 'checkbox', options: ['Aneurysm','AVM','dAVF','Cavernoma','Tumour','Venous thrombosis','Infection','Vasculitis','None'] },
          ]
        },
        section3: {
          title: 'SECTION 3: Acute Management',
          fields: [
            { name: 'orion_id', label: 'ORION Unique Patient Identifier', type: 'text', required: true },
            { name: 'hypertensive_on_admission', label: 'Hypertensive on admission?', type: 'radio', options: ['Yes','No'] },
            { name: 'sbp_range', label: 'SBP range (if yes)', type: 'radio', options: ['140–160','160–200','>200'] },
            { name: 'htn_managed', label: 'Hypertension managed', type: 'radio', options: ['Oral/topical','IV antihypertensives'] },
            { name: 'normalised_6h', label: 'Normalised within 6h', type: 'radio', options: ['Yes','No'] },
            { name: 'invasive_bp', label: 'Invasive BP monitoring', type: 'radio', options: ['Yes','No'] },
            { name: 'nimodipine', label: 'Nimodipine given (if SAH)', type: 'radio', options: ['Yes','No','NA'] },
            { name: 'investigations', label: 'Investigations checked', type: 'checkbox', options: ['FBC','Clotting','Renal','Blood type','Glucose','Temperature'] },
            { name: 'anticoag_reversed', label: 'Anticoagulants reversed', type: 'radio', options: ['Yes','No','NA'] },
            { name: 'intubated', label: 'Intubated on admission', type: 'radio', options: ['Pre-hospital','After arrival','No'] },
            { name: 'consults', label: 'Consulted specialties', type: 'checkbox', options: ['Emergency med','General med','Stroke','Neurology','Neurosurgery','ICU','IR'] },
            { name: 'therapies', label: 'Therapy services', type: 'checkbox', options: ['Physio','OT','Speech','Neuropsychology'] },
            { name: 'surgery', label: 'Surgical intervention', type: 'radio', options: ['Yes','No'] },
            { name: 'transfer', label: 'Transferred to other hospital', type: 'radio', options: ['Yes','No'] },
            { name: 'transfer_reason', label: 'Transfer reason', type: 'radio', options: ['Surgery','HDU/ICU','Neurosurgery','Stroke unit'] },
          ]
        },
        section4: {
          title: 'SECTION 4: Operative Data',
          fields: [
            { name: 'orion_id', label: 'ORION Unique Patient Identifier', type: 'text', required: true },
            { name: 'surgeon_grade', label: 'Senior surgeon grade', type: 'radio', options: ['Consultant neurosurgeon','Neurosurgeon trainee','Other surgeon','IR','Non-medical surgical provider'] },
            { name: 'anaesthesia_provider', label: 'Senior anaesthesia provider', type: 'radio', options: ['Consultant anaesthetist','Trainee','Non-medical','Surgeon','None'] },
            { name: 'anaesthesia', label: 'Anaesthesia type', type: 'radio', options: ['General','Local','None'] },
            { name: 'op_dt', label: 'Date/time of operation', type: 'datetime' },
            { name: 'duration', label: 'Duration (HH:MM)', type: 'text' },
            { name: 'preincision_abx', label: 'Pre-incision antibiotics', type: 'radio', options: ['Yes','No','Unknown'] },
            { name: 'wound_class', label: 'Surgical wound class', type: 'radio', options: ['Clean','Clean-contaminated','Contaminated','Dirty'] },
            { name: 'surgery_location', label: 'Location of surgery', type: 'radio', options: ['Right','Left','Bilateral','Midline'] },
            { name: 'main_procedure', label: 'Main procedure', type: 'text' },
            { name: 'evd_ld_location', label: 'EVD or LD performed location', type: 'radio', options: ['OT','Bedside'] },
            { name: 'bone_flap', label: 'Bone flap management', type: 'radio', options: ['Replaced','Floating','Removed–abdomen','Stored','Discarded'] },
            { name: 'duraplasty', label: 'Duraplasty performed', type: 'radio', options: ['Yes','No'] },
            { name: 'duraplasty_type', label: 'Type of duraplasty', type: 'radio', options: ['Autologous','Non-autologous','Watertight','Not watertight'] },
            { name: 'wound_drain', label: 'Wound drain placed', type: 'radio', options: ['Yes','No'] },
            { name: 'icp_monitor', label: 'ICP monitor inserted', type: 'radio', options: ['Yes','No'] },
            { name: 'microscope', label: 'Microscope used', type: 'radio', options: ['Used','Available not used','Not available'] },
            { name: 'image_guidance', label: 'Image guidance used', type: 'radio', options: ['Used','Available not used','Not available'] },
            { name: 'intraop_death', label: 'Intraoperative death', type: 'radio', options: ['Yes','No'] },
            { name: 'second_op', label: 'Second operation for ICH', type: 'radio', options: ['Yes','No'] },
          ]
        },
        section5: {
          title: 'SECTION 5: Outcome Data (30 days)',
          fields: [
            { name: 'orion_id', label: 'ORION Unique Patient Identifier', type: 'text', required: true },
            { name: 'death_30d', label: 'Death within 30 days', type: 'radio', options: ['Yes','No'] },
            { name: 'death_date', label: 'Date of death', type: 'date' },
            { name: 'still_inpatient', label: 'Still inpatient at 30 days', type: 'radio', options: ['Yes','No'] },
            { name: 'discharge_date', label: 'Date of discharge', type: 'date' },
            { name: 'discharge_dest', label: 'Discharge destination', type: 'radio', options: ['Home','Rehab','Acute hospital','Unknown'] },
            { name: 'icu_admission', label: 'ICU admission during 30 days', type: 'radio', options: ['Yes','No','Unknown'] },
            { name: 'icu_admission_date', label: 'Date of ICU admission', type: 'date' },
            { name: 'icu_discharged', label: 'Discharged from ICU', type: 'radio', options: ['Yes','No'] },
            { name: 'intubation', label: 'Intubation and ventilation', type: 'radio', options: ['Yes','No'] },
            { name: 'tracheostomy', label: 'Tracheostomy', type: 'radio', options: ['Yes','No'] },
            { name: 'vent_support_end', label: 'Ventilatory support at end', type: 'radio', options: ['Yes','No'] },
            { name: 'adverse_events', label: 'Adverse events', type: 'checkbox', options: ['None','Pressure ulcer','Pneumonia','PE','DVT','Hyponatraemia','Re-bleed','DCI','Hydrocephalus','Seizures'] },
            { name: 'dci_dx', label: 'DCI diagnosis method', type: 'radio', options: ['Clinical','Imaging'] },
            { name: 'dci_tx', label: 'DCI treatment', type: 'radio', options: ['None','IV hydration','BP augmentation','Angiographic'] },
            { name: 'hydro_tx', label: 'Hydrocephalus treatment', type: 'radio', options: ['LP','Temporary drain','VP shunt','Not treated'] },
            { name: 'sz_tx', label: 'Seizure treatment', type: 'radio', options: ['None','Antiepileptics'] },
            { name: 'ssi', label: 'Surgical site infection', type: 'radio', options: ['Superficial','Deep','No','NA'] },
            { name: 'ssi_tx', label: 'SSI treatment', type: 'radio', options: ['Antibiotics','Debridement','Removal/washout'] },
            { name: 'return_or', label: 'Return to OR', type: 'radio', options: ['Planned','Unplanned','No'] },
            { name: 'mrs', label: 'Modified Rankin Scale (0–6)', type: 'select', options: ['0','1','2','3','4','5','6'] },
            { name: 'gcs_30d', label: 'GCS at 30 days (total)', type: 'number' },
          ]
        }
      };

      function Field(props) {
        var f = props.f; var value = props.value; var onChange = props.onChange; var id = f.name;
        if (f.type === 'textarea') return (
          React.createElement('div', { className: 'grid gap-1' },
            React.createElement('label', { htmlFor: id, className: 'text-sm font-medium' }, f.label, f.required ? React.createElement('span', { className: 'text-red-500' }, ' *') : null),
            React.createElement('textarea', { id: id, className: 'border rounded-md p-2', value: value || '', onChange: function(e){ onChange(f.name, e.target.value); } })
          )
        );
        if (f.type === 'number') return (
          React.createElement('div', { className: 'grid gap-1' },
            React.createElement('label', { htmlFor: id, className: 'text-sm font-medium' }, f.label, f.required ? React.createElement('span', { className: 'text-red-500' }, ' *') : null),
            React.createElement('input', { id: id, type: 'number', className: 'border rounded-md p-2', value: value || '', onChange: function(e){ onChange(f.name, e.target.value); } })
          )
        );
        if (f.type === 'date' || f.type === 'time' || f.type === 'datetime') return (
          React.createElement('div', { className: 'grid gap-1' },
            React.createElement('label', { htmlFor: id, className: 'text-sm font-medium' }, f.label, f.required ? React.createElement('span', { className: 'text-red-500' }, ' *') : null),
            React.createElement('input', { id: id, type: (f.type === 'datetime' ? 'datetime-local' : f.type), className: 'border rounded-md p-2', value: value || '', onChange: function(e){ onChange(f.name, e.target.value); } })
          )
        );
        if (f.type === 'radio') return (
          React.createElement('div', { className: 'grid gap-1' },
            React.createElement('div', { className: 'text-sm font-medium' }, f.label, f.required ? React.createElement('span', { className: 'text-red-500' }, ' *') : null),
            React.createElement('div', { className: 'flex flex-wrap gap-2' },
              f.options.map(function(opt){
                return React.createElement('label', { key: opt, className: 'border rounded-md px-3 py-1 cursor-pointer ' + (value === opt ? 'bg-gray-100' : '') },
                  React.createElement('input', { className: 'hidden', type: 'radio', name: id, checked: value === opt, onChange: function(){ onChange(f.name, opt); } }),
                  opt
                );
              })
            )
          )
        );
        if (f.type === 'select') return (
          React.createElement('div', { className: 'grid gap-1' },
            React.createElement('div', { className: 'text-sm font-medium' }, f.label, f.required ? React.createElement('span', { className: 'text-red-500' }, ' *') : null),
            React.createElement('select', { className: 'border rounded-md p-2', value: value || '', onChange: function(e){ onChange(f.name, e.target.value); } },
              React.createElement('option', { value: '' }, 'Select'),
              f.options.map(function(opt){ return React.createElement('option', { key: opt, value: opt }, opt); })
            )
          )
        );
        if (f.type === 'checkbox') return (
          React.createElement('div', { className: 'grid gap-1' },
            React.createElement('div', { className: 'text-sm font-medium' }, f.label),
            React.createElement('div', { className: 'flex flex-wrap gap-2' },
              f.options.map(function(opt){
                var arr = Array.isArray(value) ? value : [];
                var checked = arr.indexOf(opt) > -1;
                return React.createElement('label', { key: opt, className: 'border rounded-md px-3 py-1 cursor-pointer ' + (checked ? 'bg-gray-100' : '') },
                  React.createElement('input', { className: 'hidden', type: 'checkbox', checked: checked, onChange: function(e){
                    var next = {};
                    arr.forEach(function(x){ next[x] = true; });
                    if (e.target.checked) { next[opt] = true; } else { delete next[opt]; }
                    onChange(f.name, Object.keys(next));
                  } }),
                  opt
                );
              })
            )
          )
        );
        return (
          React.createElement('div', { className: 'grid gap-1' },
            React.createElement('label', { htmlFor: id, className: 'text-sm font-medium' }, f.label, f.required ? React.createElement('span', { className: 'text-red-500' }, ' *') : null),
            React.createElement('input', { id: id, className: 'border rounded-md p-2', value: value || '', onChange: function(e){ onChange(f.name, e.target.value); } })
          )
        );
      }

      function SectionForm(props) {
        var sectionKey = props.sectionKey; var fields = props.fields; var onSave = props.onSave; var store = props.store;
        var _useState = useState(function(){ return { orion_id: '' }; }), form = _useState[0], setForm = _useState[1];

        useEffect(function(){
          var orion = (form && form.orion_id ? String(form.orion_id).trim() : '');
          if (orion && store && store[orion] && store[orion][sectionKey]) {
            var toMerge = store[orion][sectionKey];
            setForm(function(prev){ var next = {}; for (var k in prev) next[k] = prev[k]; for (var k2 in toMerge) next[k2] = toMerge[k2]; return next; });
          }
        }, [form && form.orion_id]);

        function update(name, value){ setForm(function(prev){ var next = {}; for (var k in prev) next[k] = prev[k]; next[name] = value; return next; }); }

        function handleSave(){
          if (!form || !form.orion_id || String(form.orion_id).trim() === '') { alert('ORION Unique Patient Identifier is required.'); return; }
          var numFields = fields.filter(function(f){ return f.type === 'number'; });
          for (var i=0;i<numFields.length;i++){
            var f = numFields[i]; var v = form[f.name];
            if (v !== undefined && v !== '' && isNaN(Number(v))) { alert(f.label + ' must be numeric'); return; }
          }
          onSave(sectionKey, form);
          alert('Section saved for ORION ' + String(form.orion_id).trim());
        }

        return (
          React.createElement('div', { className: 'grid gap-4' },
            fields.map(function(f){ return React.createElement(Field, { key: f.name, f: f, value: form[f.name], onChange: update }); }),
            React.createElement('div', { className: 'flex gap-2' },
              React.createElement('button', { onClick: handleSave, className: 'inline-flex items-center gap-2 px-4 py-2 rounded-md bg-gray-900 text-white' }, 'Save Section')
            )
          )
        );
      }

      function MergedPreview(props) {
        var rows = props.rows;
        if (!rows.length) return React.createElement('p', { className: 'text-sm text-gray-500' }, 'No data yet. Save any section to see merged preview.');
        return (
          React.createElement('div', { className: 'overflow-x-auto border rounded-md' },
            React.createElement('table', { className: 'w-full text-sm' },
              React.createElement('thead', null,
                React.createElement('tr', { className: 'bg-gray-100' },
                  React.createElement('th', { className: 'px-2 py-2 text-left' }, 'ORION UPI'),
                  React.createElement('th', { className: 'px-2 py-2 text-left' }, 'Sections Completed'),
                  React.createElement('th', { className: 'px-2 py-2 text-left' }, 'Last Updated')
                )
              ),
              React.createElement('tbody', null,
                rows.map(function(row){
                  var orion_id = row.orion_id; var data = row.data || {};
                  var sectionsCompleted = Object.keys(schema).filter(function(k){ return !!data[k]; }).join(', ');
                  var updatedAt = (data.meta && data.meta.updatedAt ? data.meta.updatedAt : '');
                  var displayDate = updatedAt ? updatedAt.slice(0,19).replace('T',' ') : '—';
                  return React.createElement('tr', { key: orion_id, className: 'border-t' },
                    React.createElement('td', { className: 'px-2 py-2 font-medium' }, orion_id),
                    React.createElement('td', { className: 'px-2 py-2' }, sectionsCompleted || '—'),
                    React.createElement('td', { className: 'px-2 py-2' }, displayDate)
                  );
                })
              )
            )
          )
        );
      }

      function App(){
        var _s = useLocalStorage(SET_KEY, { theme: 'light' }); var settings = _s[0], setSettings = _s[1];
        useEffect(function(){ document.documentElement.classList.toggle('dark', settings && settings.theme === 'dark'); }, [settings && settings.theme]);
        var _st = useLocalStorage(STORE_KEY, {}); var store = _st[0], setStore = _st[1];
        var _tab = useState('section1'); var active = _tab[0], setActive = _tab[1];

        function saveSection(sectionKey, data){
          var orion = (data && data.orion_id ? String(data.orion_id).trim() : '');
          if (!orion) { alert('ORION Unique Patient Identifier is required.'); return; }
          setStore(function(prev){
            prev = prev || {}; var next = {}; for (var k in prev) next[k] = prev[k];
            var current = next[orion] || {};
            var mergedSec = {}; var prevSec = current[sectionKey] || {}; for (var k2 in prevSec) mergedSec[k2] = prevSec[k2]; for (var k3 in data) mergedSec[k3] = data[k3];
            current[sectionKey] = mergedSec;
            current.meta = { updatedAt: new Date().toISOString() };
            next[orion] = current;
            return next;
          });
        }

        function clearAll(){ if (confirm('This will erase all locally saved data on this device. Continue?')) setStore({}); }

        function importJSON(file){
          var reader = new FileReader();
          reader.onload = function(){
            try { var obj = JSON.parse(String(reader.result)); if (obj && typeof obj === 'object') setStore(obj); else alert('Invalid JSON'); }
            catch (e) { alert('Could not parse JSON'); }
          };
          reader.readAsText(file);
        }

        function exportJSON(){
          var blob = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href = url; a.download = 'plotich_store_' + new Date().toISOString().slice(0,10) + '.json'; a.click(); URL.revokeObjectURL(url);
        }

        function exportCSV(){
          var rows = buildFlattenRows(schema, store);
          if (!rows.length) { alert('No data to export'); return; }
          var cols = buildFlatColumns(schema);
          var csv = [cols.join(',')].concat(rows.map(function(r){ return cols.map(function(c){ return csvEscape(r[c]); }).join(','); })).join('\n');
          var blob = new Blob([csv], { type: 'text/csv' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href = url; a.download = 'PLOT-ICH_merged_' + new Date().toISOString().slice(0,10) + '.csv'; a.click(); URL.revokeObjectURL(url);
        }

        function exportXLSX(){
          var rows = buildFlattenRows(schema, store);
          if (!rows.length) { alert('No data to export'); return; }
          var ws = XLSX.utils.json_to_sheet(rows, { header: buildFlatColumns(schema) });
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Merged');
          var wbout = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
          var blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href = url; a.download = 'PLOT-ICH_merged_' + new Date().toISOString().slice(0,10) + '.xlsx'; a.click(); URL.revokeObjectURL(url);
        }

        useEffect(function(){
          if (window.__plotich_tests_run) return; window.__plotich_tests_run = true;
          console.assert(csvEscape('plain') === 'plain');
          console.assert(csvEscape('a,b').charAt(0) === '"' && csvEscape('a,b').slice(-1) === '"');
          console.assert(csvEscape('He said "hi"').indexOf('""hi""') > -1);
          var tStore = {
            ABC123: { section1: { orion_id: 'ABC123', age: 45 }, section2: { orion_id: 'ABC123', ich_score: 2 } },
            XYZ999: { section3: { orion_id: 'XYZ999', surgery: 'No' } }
          };
          var rows = buildFlattenRows(schema, tStore);
          console.assert(!!rows.filter(function(r){ return r.orion_id === 'ABC123'; }).length);
          console.assert(!!rows.filter(function(r){ return r.orion_id === 'XYZ999'; }).length);
        }, []);

        return (
          React.createElement('div', { className: 'max-w-6xl mx-auto p-4 md:p-8' },
            React.createElement('div', { className: 'flex items-center justify-between mb-6' },
              React.createElement('div', { className: 'space-y-1' },
                React.createElement('h1', { className: 'text-2xl md:text-3xl font-bold' }, 'PLOT‑ICH eCRF – Partial Capture'),
                React.createElement('p', { className: 'text-sm text-gray-500' }, 'Save each section at different times; export one Excel later.')
              ),
              React.createElement('div', { className: 'flex gap-2' },
                React.createElement('button', { className: 'px-3 py-2 border rounded-md', onClick: function(){ setSettings(function(s){ s = s || { theme: 'light' }; return { theme: s.theme === 'dark' ? 'light' : 'dark' }; }); } }, (settings && settings.theme === 'dark') ? 'Light' : 'Dark'),
                React.createElement('button', { className: 'px-3 py-2 border rounded-md', onClick: function(){ location.reload(); } }, 'Reload')
              )
            ),
            React.createElement('div', { className: 'grid grid-cols-1 gap-4' },
              React.createElement('div', { className: 'flex gap-2 flex-wrap' },
                Object.keys(schema).map(function(k){
                  var sec = schema[k];
                  return React.createElement('button', { key: k, onClick: function(){ setActive(k); }, className: 'px-3 py-2 rounded-md border ' + (k === active ? 'bg-gray-900 text-white' : 'bg-white') }, sec.title.split(':')[0]);
                }),
                React.createElement('button', { onClick: function(){ setActive('export'); }, className: 'px-3 py-2 rounded-md border ' + (active === 'export' ? 'bg-gray-900 text-white' : 'bg-white') }, 'Review & Export')
              ),
              active !== 'export' ? React.createElement('div', { className: 'border rounded-lg p-4' },
                React.createElement('div', { className: 'mb-2' },
                  React.createElement('h2', { className: 'text-lg font-semibold' }, schema[active].title),
                  React.createElement('p', { className: 'text-sm text-gray-500' }, 'Enter data for this section and click Save Section. ORION UPI is mandatory.')
                ),
                React.createElement(SectionForm, { sectionKey: active, fields: schema[active].fields, onSave: saveSection, store: store })
              ) : null,
              active === 'export' ? React.createElement('div', { className: 'border rounded-lg p-4 space-y-4' },
                React.createElement('div', { className: 'flex gap-2 flex-wrap' },
                  React.createElement('button', { className: 'px-3 py-2 rounded-md bg-gray-900 text-white', onClick: exportCSV }, 'Export CSV'),
                  React.createElement('button', { className: 'px-3 py-2 rounded-md bg-gray-900 text-white', onClick: exportXLSX }, 'Export Excel (.xlsx)'),
                  React.createElement('button', { className: 'px-3 py-2 rounded-md border', onClick: exportJSON }, 'Export JSON'),
                  React.createElement('label', { className: 'inline-flex items-center gap-2 cursor-pointer' },
                    React.createElement('span', null, 'Import JSON'),
                    React.createElement('input', { type: 'file', accept: 'application/json', className: 'hidden', onChange: function(e){ if (e && e.target && e.target.files && e.target.files[0]) importJSON(e.target.files[0]); } })
                  ),
                  React.createElement('button', { className: 'px-3 py-2 rounded-md bg-red-600 text-white', onClick: clearAll }, 'Clear All')
                ),
                React.createElement(MergedPreview, { rows: Object.keys(store).map(function(orion){ return { orion_id: orion, data: store[orion] }; }) })
              ) : null
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    })();
  </script>
</body>
</html>
